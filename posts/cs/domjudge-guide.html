<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enonya's Blog</title>

	<link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">

	<link rel="stylesheet" href="/css/code.css">
	<link rel="stylesheet" href="/css/toc.css">
	<link rel="stylesheet" href="/css/to-top.css">

	<script src="/js/highlight.min.js"></script>
	<script>
	  document.addEventListener('DOMContentLoaded', (event) => {
		document.querySelectorAll('pre code').forEach((el) => {
		  hljs.highlightElement(el);
		});
	  });
	</script>
    
	<script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                renderActions: {
                    addMenu: [0, '', '']
                }
            },
            chtml: {
                displayAlign: 'center',
                displayIndent: '2em'
            }
        };
    </script>

    <script src="/js/Mathjax.js" async></script>
	<script src="/js/toc.js"></script>
	<script src="/js/to-top.js"></script>
    
	<link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="site-title">Mercury Lamp</h1>
            <nav>
                <ul class="nav-links">
                    <li><a href="/index.html" class="nav-link">Index</a></li>
                    <li><a href="/categories.html" class="nav-link">Categories</a></li>
                    <li><a href="/links.html" class="nav-link">Links</a></li>
                    <li><a href="/contact.html" class="nav-link">Contact</a></li>
                    <li><a href="/resource.html" class="nav-link">Resource</a></li>
                </ul>
            </nav>
        </header>
        
        <article>
            <h2>DOMjudge 搭建记录</h2>
<p>最近在给学校的 CQUOJ 更新换代，在正式开始干活之前先自己走遍流程顺便记录一下。</p>
<p>Server 和 Judgehost 都从 Docker 直接安装，方便。</p>
<h3>设备</h3>
<ul>
<li>Ubuntu 22.04 LTS</li>
<li>2Core 4GiB 40GB</li>
</ul>
<h3>环境配置</h3>
<ul>
<li>vim：毕竟只是改点配置文件 也没必要单独做配置。</li>
<li>grub 改参数：<ul>
<li><code>GRUB_CMDLINE_LINUX_DEFAULT="quiet cgroup_enable=memory swapaccount=1 isolcpus=2 systemd.unified_cgroup_hierarchy=0"</code></li>
<li>这句话主要是为了后续安装 docker 方便。</li>
<li>具体功能是：开启内存限制，交换分区统计，隔离一个 cpu 出来跑手动绑核的进程，强制 v1 cgroup 来兼容。</li>
<li>改完记得 <code>reboot</code></li>
</ul>
</li>
<li>docker: 照着文档安装就好：</li>
</ul>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>remove<span class="w"> </span>-y<span class="w"> </span>docker<span class="w"> </span>docker-engine<span class="w"> </span>docker.io<span class="w"> </span>containerd<span class="w"> </span>runc<span class="w"> </span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w">  </span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ca-certificates<span class="w"> </span>curl<span class="w"> </span>gnupg<span class="w"> </span>lsb-release<span class="w">  </span>
curl<span class="w"> </span>-fsSL<span class="w"> </span>https://download.docker.com/linux/ubuntu/gpg<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/docker-archive-keyring.gpg<span class="w">  </span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [arch=</span><span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span><span class="s2"> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span class="k">$(</span>lsb_release<span class="w"> </span>-cs<span class="k">)</span><span class="s2"> stable&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/docker.list<span class="w"> </span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w">  </span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io<span class="w">  </span>
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>docker<span class="w">  </span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>docker<span class="w">  </span>
sudo<span class="w"> </span>curl<span class="w"> </span>-L<span class="w"> </span><span class="s2">&quot;https://github.com/docker/compose/releases/latest/download/docker-compose-</span><span class="k">$(</span>uname<span class="w"> </span>-s<span class="k">)</span><span class="s2">-</span><span class="k">$(</span>uname<span class="w"> </span>-m<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span>/usr/local/bin/docker-compose
sudo<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/usr/local/bin/docker-compose
sudo<span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>/usr/local/bin/docker-compose<span class="w"> </span>/usr/bin/docker-compose<span class="w">  </span>
</code></pre></div>

<p>整个地方放所有的东西，然后设置系统服务</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/docker-compose
sudo<span class="w"> </span>vim<span class="w"> </span>/etc/systemd/system/docker-compose@.service
</code></pre></div>

<p>在系统服务文件里添加：</p>
<div class="codehilite"><pre><span></span><code><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">%i service deployed with docker compose</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">docker.service</span>
<span class="na">After</span><span class="o">=</span><span class="s">docker.service</span>

<span class="k">[Service]</span>
<span class="na">user</span><span class="o">=</span><span class="s">root</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/etc/docker-compose/%i</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/docker compose up --remove-orphans</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>

<p>并重新载入一次系统文件</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div>

<h3>主机部署</h3>
<p>Under <code>/etc/docker-compose/</code>：</p>
<p>database.secret</p>
<div class="codehilite"><pre><span></span><code>MYSQL_ROOT_PASSWORD=&lt;YOUR PASSWORD&gt;
MYSQL_PASSWORD=&lt;YOUR PASSWORD&gt;
</code></pre></div>

<p>docker-compose.yml</p>
<div class="codehilite"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.9&quot;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dj-mariadb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dj-mariadb</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mariadb:11.6.2</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;13306:3306&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./database:/var/lib/mysql</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database.secret</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_USER=domjudge</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE=domjudge</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CONTAINER_TIMEZONE=Asia/Shanghai</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--max-connections=1024 --max-allowed-packet=1G --innodb-log-file-size=512M</span>
<span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysqladmin ping -h localhost -u $$MYSQL_USER --password=$$MYSQL_PASSWORD</span>
<span class="w">      </span><span class="nt">start_period</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1s</span>
<span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>

<span class="w">  </span><span class="nt">domserver</span><span class="p">:</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domserver</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domjudge/domserver:8.2.3</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:80&quot;</span>
<span class="w">    </span><span class="nt">links</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;dj-mariadb:mariadb&#39;</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="nt">dj-mariadb</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> condition</span><span class="p">:</span><span class="w"> </span><span class="nv">service_healthy</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database.secret</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_HOST=mariadb</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_USER=domjudge</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE=domjudge</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CONTAINER_TIMEZONE=Asia/Shanghai</span>

<span class="w">  </span><span class="nt">judgehost</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;domjudge/judgehost:8.2.3&#39;</span>
<span class="w">    </span><span class="nt">links</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;domserver:domserver&#39;</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="nt">domserver</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> condition</span><span class="p">:</span><span class="w"> </span><span class="nv">service_healthy</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="c1">#- /sys/fs/cgroup:/sys/fs/cgroup:ro</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup/cpuset:/sys/fs/cgroup/cpuset:rw</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup/memory:/sys/fs/cgroup/memory:rw</span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">judgehost.secret</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CONTAINER_TIMEZONE=Asia/Shanghai</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicated</span>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">      </span><span class="nt">endpoint_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsrr</span>
<span class="w">      </span><span class="nt">restart_policy</span><span class="p">:</span>
<span class="w">        </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">on-failure</span>
<span class="w">        </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">        </span><span class="nt">max_attempts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</code></pre></div>

<p>进 docker 里安装 mysql：</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>dj-mariadb<span class="w"> </span>/bin/bash
<span class="c1">#root:</span>
apt<span class="w"> </span>update
apt<span class="w"> </span>install<span class="w"> </span>mysql-client
</code></pre></div>

<p>出来启动 server 端</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span>dj-mariadb<span class="w"> </span>domserver
</code></pre></div>

<p>获取一下 judgehost 的 API key</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>domserver<span class="w"> </span>cat<span class="w"> </span>/opt/domjudge/domserver/etc/restapi.secret
</code></pre></div>

<p>丢进 <code>/etc/docker-compose/judgehost.secret</code> </p>
<p>生成 <code>admin</code> 的密码：</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>domserver<span class="w"> </span>cat<span class="w"> </span>/opt/domjudge/domserver/etc/initial_admin_password.secret
</code></pre></div>

<p>启动 docker 的所有服务</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>

<p>确认能用之后直接访问主机 ip 即可。</p>
<p>最后设置一下系统服务自启动：</p>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>docker-compose@domjudge.service
</code></pre></div>

<h3>比赛配置</h3>
<h3>打印机/小票配置</h3>
        </article>
        
        <footer>
            <div class="footer-content">
                <span class="copyright">Copyright © Enonya since 2019</span>
            </div>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof MathJax !== 'undefined') {
                MathJax.startup.defaultReady();
                MathJax.typesetPromise().catch(function(err) {
                    console.log('MathJax typeset error:', err);
                });
            }
        });
    </script>
</body>
</html>
